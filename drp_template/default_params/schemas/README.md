# Parameters File Schema

This directory contains the JSON Schema for `parameters.json` files generated by drp_template.

## Schema Version: 1.0

The current schema version is **1.0**. All parameter files include a `schema_version` field for forward/backward compatibility.

## Required Fields

Every parameters file must include these provenance fields:

| Field | Type | Description | Example |
|-------|------|-------------|---------|
| `schema_version` | string | Schema version (format: `"major.minor"`) | `"1.0"` |
| `generator` | string | Tool that created the file with version | `"drp_template v0.1.0"` |
| `created_at` | string | Timestamp when file was first created | `"2025-10-31 11:11:37"` |
| `modified_at` | string | Timestamp of last modification | `"2025-10-31 15:30:12"` |

### Field Semantics

- **schema_version**: Indicates the structure of this file. If you see errors reading old files after upgrading, check this field.
### Field Semantics

- **created_at**: Set once when the file is first created. On subsequent updates, this field is preserved.
- **modified_at**: Updated every time the file is written, reflecting the last modification.
- **generator**: Identifies the tool and version that generated the file (e.g., `"drp_template v0.1.0"`).

## Optional Fields

Common data fields (automatically populated during imports):

| Field | Type | Description | Example |
|-------|------|-------------|---------|
| `file_path` | string | Path to the raw data file | `"../../02_Data/model.raw"` |
| `file_format` | string | Format of the data file | `"raw"`, `"tiff"`, `"mat"` |
| `dtype` | string | NumPy data type | `"uint8"`, `"uint16"`, `"float32"` |
| `endian` | string | Byte order | `"big"`, `"small"`, `"little"` |
| `dim` | integer | Number of dimensions (1–4) | `3` |
| `nx`, `ny`, `nz` | integer | Dimensions along each axis (≥1) | `400` |
| `voxel_size` | number | Physical voxel size (any unit) | `27.6` |
| `file_size_bytes` | integer | On-disk file size in bytes | `64000000` |
| `file_size_mb` | number | On-disk file size in MB (rounded) | `61.04` |

## Example Complete File

```json
{
    "schema_version": "1.0",
    "generator": "drp_template v0.1.0",
    "created_at": "2025-10-31 11:11:37",
    "modified_at": "2025-10-31 11:11:37",
    "file_path": "../../02_Data/sandstone_400cube.raw",
    "file_format": "raw",
    "dtype": "uint8",
    "endian": "big",
    "dim": 3,
    "nx": 400,
    "ny": 400,
    "nz": 400,
    "voxel_size": 27.6,
    "file_size_bytes": 64000000,
    "file_size_mb": 61.04,
    "labels": {
        "0": "Pore",
        "1": "Quartz",
        "2": "Feldspar"
    }
}
```

## Versioning Policy

### When to Bump Schema Version

Increment `SCHEMA_VERSION` in `drp_template/default_params/_funcs.py` when making **breaking changes**:

**Breaking changes (bump major version: 1.0 → 2.0):**
- Removing or renaming required fields
- Changing field types (e.g., `nx` from integer to string)
- Changing field semantics (e.g., redefining what `endian` means)

**Non-breaking changes (bump minor version: 1.0 → 1.1):**
- Adding new optional fields
- Tightening validation constraints (e.g., adding min/max bounds)
- Clarifying documentation

**No version bump needed:**
- Adding values to existing fields (e.g., new file formats)
- Fixing typos in documentation
- Internal code refactoring

### Migration Strategy

If you bump the schema version, consider:

1. **Backward compatibility**: Can new code still read old files?
   - If yes: users don't need to do anything
   - If no: provide a migration helper (see example below)

2. **Forward compatibility**: Can old code read new files?
   - Usually not a concern (old code ignores new fields)
   - Warn users if schema changes are critical

### Example Migration Helper (Future Use)

When you need to migrate old files to a new schema:

```python
import drp_template.default_params as dp

def migrate_parameters_file(old_file, new_file):
    """Migrate parameters.json from schema 1.0 to 2.0."""
    data = dp.read_parameters_file(paramsfile=old_file)
    
    # Example: rename 'dtype' to 'data_type' in v2.0
    if 'dtype' in data:
        data['data_type'] = data.pop('dtype')
    
    # Update schema version
    data['schema_version'] = "2.0"
    
    # Write to new file
    dp.update_parameters_file(paramsfile=new_file, **data)
```

## Validation

### Automatic Validation

Validation happens automatically:
- **On write**: `update_parameters_file()` validates before saving
- **On read**: `read_parameters_file()` validates after loading

Invalid files raise a `ValueError` with details.

### Manual Validation

To explicitly validate a file:

```python
import drp_template.default_params as dp

try:
    dp.validate_parameters_file('my_params.json')
    print("✓ File is valid")
except ValueError as e:
    print(f"✗ Validation failed: {e}")
```

### Common Validation Errors

**Missing required field:**
```
ValueError: parameters.json failed schema validation: 'schema_version' is a required property
```
→ File is from an older version or was hand-edited incorrectly

**Wrong type:**
```
ValueError: parameters.json failed schema validation: 'nx' should be an integer
```
→ Fix the field value or regenerate the file

**Out of range:**
```
ValueError: parameters.json failed schema validation: 'dim' should be between 1 and 4
```
→ Check your data dimensions

## Schema File Location

The JSON Schema definition is at:
```
drp_template/default_params/schemas/parameters.schema.json
```

It follows JSON Schema Draft-07 specification.

## Questions?

- Schema not validating? Check `schema_version` matches current version (1.0)
- Need to add custom fields? They're allowed—just document them in your workflow
- Planning a breaking change? Update this README and bump `SCHEMA_VERSION`
